{
    "name": "dataflow_scdtype1",
    "properties": {
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "linkedService": {
                        "referenceName": "AzureDataLakeStorage1",
                        "type": "LinkedServiceReference"
                    },
                    "name": "source1"
                },
                {
                    "linkedService": {
                        "referenceName": "AzureSqlDatabase1",
                        "type": "LinkedServiceReference"
                    },
                    "name": "target"
                }
            ],
            "sinks": [
                {
                    "linkedService": {
                        "referenceName": "AzureSqlDatabase1",
                        "type": "LinkedServiceReference"
                    },
                    "name": "sink1"
                },
                {
                    "linkedService": {
                        "referenceName": "AzureSqlDatabase1",
                        "type": "LinkedServiceReference"
                    },
                    "name": "sink2"
                }
            ],
            "transformations": [
                {
                    "name": "renamingcolumn"
                },
                {
                    "name": "derivedColumn1"
                },
                {
                    "name": "lookup1"
                },
                {
                    "name": "split1"
                },
                {
                    "name": "derivedColumn2"
                },
                {
                    "name": "derivedColumn3"
                },
                {
                    "name": "alterRow1"
                }
            ],
            "scriptLines": [
                "source(output(",
                "          CustomerID as short,",
                "          FirstName as string,",
                "          LastName as string,",
                "          Email as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     ignoreNoFilesFound: false,",
                "     format: 'parquet',",
                "     fileSystem: 'silverlayer',",
                "     folderPath: 'customer',",
                "     fileName: 'part-00000-38056f58-dc24-49f5-b5e5-a6909921f7d1-c000.snappy.parquet') ~> source1",
                "source(output(",
                "          tgt_id as integer,",
                "          tgt_hashvalue as long",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     format: 'query',",
                "     store: 'sqlserver',",
                "     query: 'select CustomerID as tgt_id, HashValue as tgt_hashvalue from CustomerType1',",
                "     isolationLevel: 'READ_UNCOMMITTED') ~> target",
                "source1 select(mapColumn(",
                "          each(match(1==1),",
                "               concat('src_',$$) = $$)",
                "     ),",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> renamingcolumn",
                "renamingcolumn derive(src_hashvalue = crc32(concat(toString(src_CustomerID),src_FirstName,src_LastName,src_Email))) ~> derivedColumn1",
                "derivedColumn1, target lookup(src_CustomerID == tgt_id,",
                "     multiple: false,",
                "     pickup: 'any',",
                "     broadcast: 'auto')~> lookup1",
                "lookup1 split(isNull(tgt_id),",
                "     src_CustomerID == tgt_id && src_hashvalue != tgt_hashvalue,",
                "     disjoint: false) ~> split1@(insert, update)",
                "split1@insert derive(src_updatedBy = 'updated by dataflow',",
                "          src_updatedDate = currentTimestamp(),",
                "          src_createdBy = 'created by dataflow',",
                "          src_createdDate = currentTimestamp()) ~> derivedColumn2",
                "split1@update derive(updatedBy = \"updated By dataflow\",",
                "          updatedDate = currentTimestamp()) ~> derivedColumn3",
                "derivedColumn3 alterRow(updateIf(1==1)) ~> alterRow1",
                "derivedColumn2 sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          CustomerID as integer,",
                "          FirstName as string,",
                "          LastName as string,",
                "          Email as string,",
                "          updatedBy as string,",
                "          updatedDate as timestamp,",
                "          createdBy as string,",
                "          createdDate as timestamp,",
                "          HashValue as long",
                "     ),",
                "     format: 'table',",
                "     store: 'sqlserver',",
                "     schemaName: 'dbo',",
                "     tableName: 'CUSTOMERTYPE1',",
                "     insertable: true,",
                "     updateable: false,",
                "     deletable: false,",
                "     upsertable: false,",
                "     recreate: true,",
                "     stagingSchemaName: '',",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     errorHandlingOption: 'stopOnFirstError',",
                "     mapColumn(",
                "          CustomerID = src_CustomerID,",
                "          FirstName = src_FirstName,",
                "          LastName = src_LastName,",
                "          Email = src_Email,",
                "          updatedBy = src_updatedBy,",
                "          updatedDate = src_updatedDate,",
                "          createdBy = src_createdBy,",
                "          createdDate = src_createdDate,",
                "          HashValue = src_hashvalue",
                "     )) ~> sink1",
                "alterRow1 sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          CustomerID as integer,",
                "          FirstName as string,",
                "          LastName as string,",
                "          Email as string,",
                "          ActiveStatus as integer,",
                "          updatedBy as string,",
                "          updatedDate as timestamp,",
                "          createdBy as string,",
                "          createdDate as timestamp,",
                "          HashValue as long",
                "     ),",
                "     format: 'table',",
                "     store: 'sqlserver',",
                "     schemaName: 'dbo',",
                "     tableName: 'CUSTOMERTYPE1',",
                "     insertable: false,",
                "     updateable: true,",
                "     deletable: false,",
                "     upsertable: false,",
                "     keys:['CustomerID'],",
                "     stagingSchemaName: '',",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     errorHandlingOption: 'stopOnFirstError',",
                "     mapColumn(",
                "          CustomerID = src_CustomerID,",
                "          FirstName = src_FirstName,",
                "          LastName = src_LastName,",
                "          Email = src_Email,",
                "          updatedBy,",
                "          updatedDate,",
                "          HashValue = src_hashvalue",
                "     )) ~> sink2"
            ]
        }
    }
}